<!DOCTYPE html>
<html>
<head>
    <title>kanbantoscrum</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"releaseFilter"},{xtype:"container",itemId:"storyGrid",width:1400},{xtype:"container",itemId:"featGrid",width:1400}],launch:function(){console.log("Our first App");var updateSchedulState=!1,recordsToUpdate,_grid,_storyGrid,store=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!1,fetch:["FormattedID","Name","ScheduleState","c_KanbanStateCE","Project","Feature","Release","Description"],filters:[{property:"Project.Name",operator:"=",value:"CE Kanban"},{property:"Release.Name",operator:"=",value:"14Q2"}],listeners:{load:function(myStore,myData,success){console.log("Got Data!",success),console.log("MY Store",myStore),console.log("My Data",myData),this._initSupplementaryStores(myStore,myData)},scope:this}});this.down("#releaseFilter").add({xtype:"rallyreleasecombobox",valueField:"_refObjectName",listeners:{change:function(newValue,oldValue,eOpts){newValue!=oldValue&&(store.clearFilter(!0),store.filter([{property:"Project.Name",operator:"=",value:"CE Kanban"},{property:"Release.Name",operator:"=",value:newValue.value}]),store.load())},scope:this}})},_initSupplementaryStores:function(storyStore,storyData){var featidfilters=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:"0"});featids=[],Ext.Array.each(storyData,function(story){feature=story.get("Feature"),feature&&(featidfilters=featidfilters.or(Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:feature.FormattedID})),featids.push(feature.FormattedID))}),Rally.data.ModelFactory.getModel({type:"PortfolioItem/Feature",success:function(featureModel){console.log("Model: ",featureModel),this._onDataLoaded(storyStore,storyData,featureModel)},scope:this})},_onDataLoaded:function(storyStore,storyData,featureModel){var records=[],recordMap={},reqctr=0,reqresolved=0;Ext.Array.each(storyData,function(record){var initiativeName="";console.log(record);var feature=record.get("Feature");if(feature)if(console.log("feature: ",feature),kanbanState=record.get("c_KanbanStateCE"),recordMap.hasOwnProperty(feature.FormattedID))val=recordMap[feature.FormattedID],console.log("Fround record: ",val),val.StoryCount++,val.CompletedStories+="Accepted"==kanbanState?1:0,val.PctDoneStoryCount=(100*(val.CompletedStories/val.StoryCount)).toFixed(0);else{reqctr++,records.push(feature),recordMap[feature.FormattedID]=feature;var completedStories="Accepted"==kanbanState?1:0,pctComplete=100*completedStories;feature.PctDoneStoryCount=pctComplete,feature.StoryCount=1,feature.CompletedStories=completedStories,featureModel.load(feature._ref,{scope:this,callback:function(fullFeature,operation){if(reqresolved++,operation.wasSuccessful()){fullFeature.data.Parent&&(initiativeName=fullFeature.data.Parent.Name);var project=fullFeature.data.Project?fullFeature.data.Project.Name:"",state=fullFeature.data.State?fullFeature.data.State.Name:"";feature.ProjName=project,feature.StateName=state,feature.InitName=initiativeName}console.log("Req Resolved: "+reqresolved),reqresolved==reqctr&&this._setupFeatureGrid(records,storyData.length)}})}this.updateScheduleState&&(this._updateScheduleState(record),storyStore.sync({success:function(batch,options){console.log("Success!")},failure:function(batch,options){console.log("Success!")}}))},this),console.log("Adding : Story Grid",storyStore),this._setupStoryGrid(storyStore)},_setupFeatureGrid:function(records,length){this._grid?(console.log("Updating Grid"),this._loadGrid(records,length)):(console.log("Loading Grid"),this._loadGrid(records,length))},_updateScheduleState:function(record){var kanbanToScrum=[];kanbanToScrum.None="Needs Definition",kanbanToScrum.Defined="Defined",kanbanToScrum["Analysis/Design"]="In-Progress",kanbanToScrum["Design verified"]="In-Progress",kanbanToScrum.Coding="In-Progress",kanbanToScrum.Done="Completed",kanbanToScrum.Accepted="Accepted",console.log(kanbanToScrum),record.get("c_KanbanStateCE")&&(newSchedState=kanbanToScrum[record.get("c_KanbanStateCE")],newSchedState!=record.get("ScheduleState")&&(record.beginEdit(),record.set("ScheduleState",newSchedState),record.set("Notes",newSchedState),record.endEdit(),record.save({callback:function(records,operation,success){console.log("Records: ",records),console.log("Operation: ",operation),console.log("Success: ",success)}}),console.log("Story: ",record.get("Name")," State:",record.get("c_KanbanStateCE")," : ",newSchedState,record.get("ScheduleState"))))},_updateGrid:function(records,length){console.log("Records: ",records);var store=Ext.create("Rally.data.custom.Store",{data:records,pageSize:length});this._grid.store=store},_loadGrid:function(records,length){console.log("Records: ",records),this.down("#featGrid").add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:records,pageSize:length}),columnCfgs:[{text:"ID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name",flex:1},{text:"% Done by Story Count",dataIndex:"PctDoneStoryCount"},{text:"% Done by Plan Estimate",dataIndex:"PctDoneStoryCount"},{text:"Parent",dataIndex:"InitName"},{text:"Project",dataIndex:"ProjName"},{text:"State",dataIndex:"StateName"},{text:"Stories",dataIndex:"StoryCount"}],listeners:{add:function(component,idx,eOpt){console.log("My Grid: ",component),this._grid=component},scope:this}})},_setupStoryGrid:function(store){this._storyGrid?(console.log("Updating Grid"),this._loadStoryGrid(store)):(console.log("Loading Grid"),this._loadStoryGrid(store))},_updateStoryGrid:function(store){this._storyGrid.clearValue(),this._storyGrid.bindStore(store)},_loadStoryGrid:function(storyStore,length){this.down("#storyGrid").add({xtype:"rallygrid",store:storyStore,scope:this,columnCfgs:[{text:"Feature",dataIndex:"Feature"},{text:"FormattedID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name"},{text:"Description",dataIndex:"Description",flex:1}],listeners:{add:function(component,idx,eOpt){console.log("My Grid: ",component),this._storyGrid=component},scope:this}})},_loadKanbanCFD:function(){stateFieldValues=["None","Defined","Analysis/Design","Design verified","Coding","Done","Accepted"],Ext.define("My.CFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){for(var i=0;stateFieldValues.length>i;++i)metrics.push({as:stateFieldValues[i],groupByField:"c_KanbanStateCE",allowedValues:[stateFieldValues[i]],f:"groupByCount",display:"area"});return metrics}});var ss=Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:function(store,data,success){console.log("LookbackStore Records: ",store),console.log("Successful?: ",data),console.log("Opts: ",success)}},autoLoad:!0,fetch:["c_KanbanStateCE","PlanEstimate"],hydrate:["c_KanbanStateCE"],filters:[{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement"]},{property:"_ProjectHierarchy",operator:"=",value:14269684724}]});this.add({xtype:"rallychart",store:ss,storeConfig:{},calculatorType:"My.CFDCalculator",calculatorConfig:{},chartConfig:{chart:{type:"area"},title:{text:"Kanban CFD"},xAxis:{title:{text:"Date"}},yAxis:[{title:{text:"Points"}}],plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}}}})}});

            Rally.launchApp('CustomApp', {
                name:"kanbantoscrum",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
