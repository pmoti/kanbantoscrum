<!DOCTYPE html>
<html>
<head>
    <title>kanbantoscrum</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("Our first App");var updateSchedulState=!1,recordsToUpdate;Ext.create("Ext.Container",{items:[{xtype:"rallyreleasecombobox"}],renderTo:Ext.getBody().dom});var store=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,fetch:["FormattedID","Name","ScheduleState","c_KanbanStateCE","Project","Feature","Release"],filters:[{property:"Project.Name",operator:"=",value:"CE Kanban"},{property:"Release.Name",operator:"=",value:"14Q2"}],listeners:{load:function(myStore,myData,success){console.log("Got Data!",success),console.log("MY Store",myStore),console.log("My Data",myData),this._loadInitiativeStore(myStore,myData)},scope:this}})},_loadInitiativeStore:function(storyStore,storyData){var featidfilters=Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:"0"});Ext.Array.each(storyData,function(story){feature=story.get("Feature"),feature&&(featidfilters=featidfilters.or(Ext.create("Rally.data.wsapi.Filter",{property:"FormattedID",operator:"=",value:feature.FormattedID})))});var featureStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,filters:featidfilters,listeners:{load:function(featureStore,featureData,success){this._onDataLoaded(storyStore,storyData,featureStore,featureData)},scope:this}})},_onDataLoaded:function(storyStore,storyData,featureStore,featureData){var records=[],recordMap={};Ext.Array.each(storyData,function(record){var initiativeName="";console.log(record);var feature=record.get("Feature");if(feature&&(feature=featureStore.findRecord("FormattedID",feature.FormattedID))){feature.data.Parent&&(initiativeName=feature.data.Parent.Name);var id=feature.data.FormattedID,name=feature.data.Name,project=feature.data.Project?feature.data.Project.Name:"",state=feature.data.State?feature.data.State.Name:"";if(console.log("Feature ",feature),recordMap.hasOwnProperty(id))val=recordMap[id],val.data.StoryCount++,val.data.CompletedStories+="Accepted"==kanbanState?1:0,val.data.PctDoneStoryCount=(100*(val.data.CompletedStories/val.data.StoryCount)).toFixed(0);else{kanbanState=record.get("c_KanbanStateCE");var completedStories="Accepted"==kanbanState?1:0,pctComplete=100*completedStories;feature.data.PctDoneStoryCount=pctComplete,feature.data.StoryCount=1,feature.data.CompletedStories=completedStories,feature.data.ProjName=project,feature.data.StateName=state,feature.data.InitName=initiativeName;var customrec={FeatureId:id,Name:name,PctDoneStoryCount:pctComplete,InitiativeName:initiativeName,Project:project,State:state,StoryCount:1,CompletedStories:completedStories};recordMap[id]=feature,records.push(feature)}}this.updateScheduleState&&(this._updateScheduleState(record),storyStore.sync({success:function(batch,options){console.log("Success!")},failure:function(batch,options){console.log("Success!")}}))}),this._loadGrid(records,storyData.length)},_updateScheduleState:function(record){var kanbanToScrum=[];kanbanToScrum.None="Needs Definition",kanbanToScrum.Defined="Defined",kanbanToScrum["Analysis/Design"]="In-Progress",kanbanToScrum["Design verified"]="In-Progress",kanbanToScrum.Coding="In-Progress",kanbanToScrum.Done="Completed",kanbanToScrum.Accepted="Accepted",console.log(kanbanToScrum),record.get("c_KanbanStateCE")&&(newSchedState=kanbanToScrum[record.get("c_KanbanStateCE")],newSchedState!=record.get("ScheduleState")&&(record.beginEdit(),record.set("ScheduleState",newSchedState),record.set("Notes",newSchedState),record.endEdit(),record.save({callback:function(records,operation,success){console.log("Records: ",records),console.log("Operation: ",operation),console.log("Success: ",success)}}),console.log("Story: ",record.get("Name")," State:",record.get("c_KanbanStateCE")," : ",newSchedState,record.get("ScheduleState"))))},_loadGrid:function(records,length){console.log("Records: ",records),this.add({xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:records,pageSize:length}),columnCfgs:[{text:"ID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name"},{text:"% Done by Story Count",dataIndex:"PctDoneStoryCount"},{text:"% Done by Plan Estimate",dataIndex:"PctDoneStoryCount"},{text:"Parent",dataIndex:"InitName"},{text:"Project",dataIndex:"ProjName"},{text:"State",dataIndex:"StateName"},{text:"Stories",dataIndex:"StoryCount"}]})}});

            Rally.launchApp('CustomApp', {
                name:"kanbantoscrum",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
